# Music Upload Specification

## Supported Upload Methods

### 1. Single File Upload
- Direct upload of individual audio files
- Metadata extracted from file if available
- Manual metadata entry via form

### 2. Album ZIP Upload
Upload a ZIP file containing:
- Audio files (FLAC, MP3, OGG, M4A, WAV)
- Optional: `album.yaml` or `album.json` for metadata
- Optional: `cover.jpg` or `cover.png` for album art

### 3. Folder Structure
```
my-album.zip
├── album.yaml          # Optional metadata file
├── cover.jpg          # Optional album art
├── 01-track-one.flac
├── 02-track-two.flac
└── 03-track-three.flac
```

## Metadata File Format

### YAML Format (album.yaml)
```yaml
album:
  title: "Album Title"
  artist: "Artist Name"
  year: 2024
  genre: "Electronic"
  description: "Optional album description"
  cover: "cover.jpg"  # filename in the zip
  
  # For work-in-progress albums
  version: "demo-v3"
  release_status: "draft"  # draft, released
  
tracks:
  - file: "01-song.flac"
    title: "Song Title"
    duration: 180  # seconds (optional, auto-detected)
    featured: "Guest Artist"  # optional
    notes: "Remix version"  # optional
    
  - file: "02-song.flac"
    title: "Another Song"
    # Minimal info is fine, we'll extract the rest
```

### JSON Format (album.json)
```json
{
  "album": {
    "title": "Album Title",
    "artist": "Artist Name",
    "year": 2024,
    "genre": "Electronic",
    "cover": "cover.jpg"
  },
  "tracks": [
    {
      "file": "01-song.flac",
      "title": "Song Title"
    }
  ]
}
```

## Metadata Priority Order

1. **Explicit metadata file** (album.yaml/json) - Highest priority
2. **Embedded file metadata** (ID3, Vorbis Comments)
3. **Filename parsing** (01-song-title.flac → Track 1: "Song Title")
4. **User form input** (for single file uploads)

## Version Control for Artists

When re-uploading the same album:
- System detects matching album/artist names
- Prompts: "Update existing album or create new version?"
- Maintains version history if desired
- Can replace individual tracks without re-uploading entire album

## Supported Audio Formats

- **FLAC** - Lossless, preferred format
- **MP3** - Wide compatibility  
- **OGG Vorbis** - Open source alternative
- **M4A/AAC** - Apple ecosystem
- **WAV** - Uncompressed (supported, optionally converted)

## File Size Limits

- Single file: 500MB max
- ZIP upload: 2GB max
- Optional: Convert WAV to FLAC to save storage (user choice)

## Metadata Validation

When metadata is provided (via file or embedded), we validate:
- **Duration**: Must match actual file duration (±1 second tolerance)
- **Format**: Must match actual file format
- **Track numbers**: Must be unique within album

Validation errors return helpful messages:
```json
{
  "error": "Metadata validation failed",
  "issues": [
    {
      "track": "02-orbit.flac", 
      "field": "duration",
      "expected": 180,
      "actual": 245,
      "message": "Duration mismatch: file is 4:05, metadata says 3:00"
    }
  ]
}

## Example Upload Flow

1. Artist uploads `my-album-v2.zip`
2. System extracts and reads `album.yaml`
3. For each track:
   - Check metadata file first
   - Fall back to embedded metadata
   - Generate from filename if needed
4. If album exists, prompt for update vs new version
5. Upload files to R2 with organized structure:
   ```
   /music/{artist_id}/{album_id}/{track_id}.flac
   /music/{artist_id}/{album_id}/cover.jpg
   ```

## API Endpoints

```
POST /api/v1/upload/file
  - Single file upload with metadata form

POST /api/v1/upload/album
  - ZIP file upload
  - Multipart form data
  
GET /api/v1/upload/status/{upload_id}
  - Check processing status for large uploads

GET /api/v1/albums/{album_id}/metadata
  - Download generated metadata as YAML or JSON
  - Query param: ?format=yaml (default) or ?format=json
  
GET /api/v1/albums/{album_id}/download
  - Download album as ZIP with current metadata file included
```

## Metadata Export Feature

After upload, artists can:
1. View the generated/extracted metadata
2. Download as `album.yaml` or `album.json`
3. Edit offline with any text editor
4. Re-upload the ZIP with corrected metadata

Example generated metadata:
```yaml
# Generated by Navicore Music on 2024-07-04
# Edit this file and include it in your ZIP for better metadata

album:
  title: "Untitled Album"  # Extracted from: folder name
  artist: "Unknown Artist"  # Please update
  year: 2024
  genre: "Unknown"  # Please update
  cover: "cover.jpg"  # Found in ZIP
  
tracks:
  - file: "01 Track Name.wav"
    title: "Track Name"  # Extracted from: filename
    duration: 245  # Extracted from: file (4:05)
    # Add more fields:
    # featured: "Guest Artist"
    # notes: "Live version"
    
  - file: "02 Another Track.wav"
    title: "Another Track"  # Extracted from: filename  
    duration: 180  # Extracted from: file (3:00)
```

This helps artists:
- See what metadata we extracted
- Understand the format
- Fix any incorrect extractions
- Add missing information
- Learn the schema by example