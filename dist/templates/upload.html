<!-- Upload page content - loaded via HTMX -->
<div class="container mx-auto p-8 max-w-4xl">
    <h1 class="text-3xl font-bold mb-8">Upload Music</h1>
    
    <!-- Upload Options -->
    <div class="tabs tabs-boxed mb-8">
        <a class="tab tab-active" onclick="showUploadType('album')">Upload Album</a>
        <a class="tab" onclick="showUploadType('tracks')">Upload Tracks</a>
    </div>
    
    <!-- Album Upload Form -->
    <div id="album-upload" class="card bg-base-200">
        <div class="card-body">
            <h2 class="card-title mb-4">Upload Album as ZIP</h2>
            <form id="album-upload-form" class="space-y-4">
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Album ZIP File</span>
                        <span class="label-text-alt">Contains audio files</span>
                    </label>
                    <input type="file" 
                           name="album" 
                           accept=".zip" 
                           required 
                           class="file-input file-input-bordered w-full" />
                    <label class="label">
                        <span class="label-text-alt">Maximum 128MB</span>
                    </label>
                </div>
                
                <button type="submit" class="btn btn-primary btn-lg w-full">
                    Upload Album ZIP
                </button>
            </form>
        </div>
    </div>
    
    <!-- Individual Tracks Upload -->
    <div id="tracks-upload" class="card bg-base-200 hidden">
        <div class="card-body">
            <h2 class="card-title mb-4">Upload Individual Tracks</h2>
            <form id="tracks-upload-form" class="space-y-4">
                <!-- Album Metadata -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Artist Name</span>
                        </label>
                        <input type="text" 
                               id="artist-input"
                               placeholder="Enter artist name" 
                               required 
                               class="input input-bordered" />
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Album Title</span>
                        </label>
                        <input type="text" 
                               id="album-input"
                               placeholder="Enter album title" 
                               required 
                               class="input input-bordered" />
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Genre (Optional)</span>
                        </label>
                        <input type="text" 
                               id="genre-input"
                               placeholder="e.g., Electronic, Jazz" 
                               class="input input-bordered" />
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Year</span>
                        </label>
                        <input type="number" 
                               id="year-input"
                               placeholder="2024" 
                               min="1900" 
                               max="2099" 
                               class="input input-bordered" />
                    </div>
                </div>
                
                <!-- Track Files -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Audio Files</span>
                        <span class="label-text-alt">MP3, FLAC, OGG, M4A, WAV</span>
                    </label>
                    <input type="file" 
                           id="track-files"
                           accept=".mp3,.flac,.ogg,.m4a,.wav,audio/*" 
                           multiple 
                           required 
                           class="file-input file-input-bordered w-full" />
                    <label class="label">
                        <span class="label-text-alt">Select multiple files • Max 100MB per file</span>
                    </label>
                </div>
                
                <!-- Cover Art -->
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Album Cover (Optional)</span>
                        <span class="label-text-alt">JPG, PNG</span>
                    </label>
                    <input type="file" 
                           name="cover" 
                           accept=".jpg,.jpeg,.png,image/*" 
                           class="file-input file-input-bordered w-full" />
                </div>
                
                <!-- Track List Preview -->
                <div id="track-list-preview" class="hidden">
                    <h3 class="text-lg font-semibold mb-2">Track Order</h3>
                    
                    <!-- Large file warning banner -->
                    <div id="large-file-warning" class="alert alert-info mb-4 hidden">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <h3 class="font-bold">Files over 100MB will be skipped</h3>
                            <p>Due to upload limits, large files cannot be uploaded and will be automatically skipped.</p>
                        </div>
                    </div>
                    
                    <div class="bg-base-300 rounded-lg p-4">
                        <div id="track-list" class="space-y-2">
                            <!-- Tracks will be listed here -->
                        </div>
                        <p class="text-sm text-base-content/70 mt-2">
                            Drag to reorder tracks • Click track name to edit
                        </p>
                    </div>
                </div>
                
                <button type="submit" class="btn btn-primary btn-lg w-full">
                    Upload Album
                </button>
            </form>
        </div>
    </div>
    
    <!-- Upload Progress -->
    <div id="upload-progress" class="hidden">
        <div class="card bg-base-200">
            <div class="card-body">
                <h3 class="card-title mb-4">Uploading Album...</h3>
                
                <!-- Overall Progress -->
                <div class="mb-4">
                    <div class="flex justify-between text-sm mb-1">
                        <span>Overall Progress</span>
                        <span id="overall-progress-text">0%</span>
                    </div>
                    <progress id="overall-progress" class="progress progress-primary w-full" value="0" max="100"></progress>
                </div>
                
                <!-- Individual Track Progress -->
                <div id="track-progress-list" class="space-y-3">
                    <!-- Individual progress bars will appear here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Results -->
    <div id="upload-results" class="hidden">
        <!-- Success or error messages will appear here -->
    </div>
</div>

<script>
    let selectedTracks = [];
    let uploadedTracks = [];
    
    // Set default year
    document.getElementById('year-input').value = new Date().getFullYear();
    
    // Handle file selection
    document.getElementById('track-files').addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        const maxSize = 100 * 1024 * 1024; // 100MB limit
        
        selectedTracks = files.map((file, index) => ({
            file: file,
            name: extractTrackName(file.name),
            trackNumber: index + 1,
            status: 'pending',
            isLarge: file.size > maxSize
        }));
        
        updateTrackListPreview();
    });
    
    function extractTrackName(filename) {
        let name = filename.replace(/\.[^/.]+$/, '');
        name = name.replace(/^\d+[\s\-_.]*/, '');
        name = name.replace(/[\-_]/g, ' ').trim();
        return name || filename;
    }
    
    function updateTrackListPreview() {
        const hasLargeFiles = selectedTracks.some(t => t.isLarge);
        const validTracks = selectedTracks.filter(t => !t.isLarge);
        
        document.getElementById('large-file-warning').classList.toggle('hidden', !hasLargeFiles);
        
        if (selectedTracks.length > 0) {
            document.getElementById('track-list-preview').classList.remove('hidden');
            
            const trackListHtml = selectedTracks.map((track, index) => `
                <div class="flex items-center gap-3 ${track.isLarge ? 'opacity-50' : ''}" draggable="${!track.isLarge}">
                    <span class="text-lg font-semibold">${track.trackNumber}</span>
                    <input type="text" 
                           value="${track.name}" 
                           onchange="updateTrackName(${index}, this.value)"
                           class="input input-sm flex-1 ${track.isLarge ? 'input-disabled' : ''}" 
                           ${track.isLarge ? 'disabled' : ''} />
                    <span class="text-sm opacity-70">${formatFileSize(track.file.size)}</span>
                    ${track.isLarge ? '<span class="badge badge-warning">Too Large</span>' : ''}
                </div>
            `).join('');
            
            document.getElementById('track-list').innerHTML = trackListHtml;
        } else {
            document.getElementById('track-list-preview').classList.add('hidden');
        }
    }
    
    function updateTrackName(index, newName) {
        selectedTracks[index].name = newName;
    }
    
    function formatFileSize(bytes) {
        if (bytes < 1024 * 1024) {
            return (bytes / 1024).toFixed(1) + ' KB';
        }
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    function showUploadType(type) {
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('tab-active');
        });
        event.target.classList.add('tab-active');
        
        if (type === 'album') {
            document.getElementById('album-upload').classList.remove('hidden');
            document.getElementById('tracks-upload').classList.add('hidden');
        } else {
            document.getElementById('album-upload').classList.add('hidden');
            document.getElementById('tracks-upload').classList.remove('hidden');
        }
    }
    
    // Album upload handler
    document.getElementById('album-upload-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const fileInput = e.target.querySelector('input[name="album"]');
        const file = fileInput.files[0];
        
        if (!file) return;
        
        document.getElementById('album-upload').classList.add('hidden');
        document.getElementById('upload-progress').classList.remove('hidden');
        
        const formData = new FormData();
        formData.append('album', file);
        
        try {
            const response = await fetch('https://api.navicore.tech/api/v1/upload/album', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showUploadResults(true, result);
            } else {
                showUploadResults(false, result);
            }
        } catch (error) {
            showUploadResults(false, { error: error.message });
        }
    });
    
    // Individual tracks upload handler
    document.getElementById('tracks-upload-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const artist = document.getElementById('artist-input').value;
        const album = document.getElementById('album-input').value;
        const genre = document.getElementById('genre-input').value;
        const year = document.getElementById('year-input').value;
        
        const tracksToUpload = selectedTracks.filter(t => !t.isLarge);
        
        if (tracksToUpload.length === 0) {
            alert('No valid tracks to upload');
            return;
        }
        
        document.getElementById('tracks-upload').classList.add('hidden');
        document.getElementById('upload-progress').classList.remove('hidden');
        
        let uploadedCount = 0;
        uploadedTracks = [];
        
        for (let i = 0; i < tracksToUpload.length; i++) {
            const track = tracksToUpload[i];
            updateProgress(i, tracksToUpload.length, track.name);
            
            const formData = new FormData();
            formData.append('file', track.file);
            formData.append('metadata', JSON.stringify({
                title: track.name,
                artist: artist,
                album: album,
                genre: genre,
                year: parseInt(year),
                track_number: track.trackNumber
            }));
            
            try {
                const response = await fetch('https://api.navicore.tech/api/v1/upload/file', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    uploadedTracks.push(result.track);
                    uploadedCount++;
                }
            } catch (error) {
                console.error(`Failed to upload ${track.name}:`, error);
            }
        }
        
        showUploadResults(uploadedCount > 0, {
            message: `Successfully uploaded ${uploadedCount} of ${tracksToUpload.length} tracks`,
            tracks: uploadedTracks
        });
    });
    
    function updateProgress(current, total, trackName) {
        const percent = Math.round((current / total) * 100);
        document.getElementById('overall-progress').value = percent;
        document.getElementById('overall-progress-text').textContent = `${percent}%`;
        
        if (current === 0) {
            document.getElementById('track-progress-list').innerHTML = '';
        }
        
        document.getElementById('track-progress-list').innerHTML += `
            <div class="text-sm opacity-70">Uploading: ${trackName}</div>
        `;
    }
    
    function showUploadResults(success, result) {
        document.getElementById('upload-progress').classList.add('hidden');
        document.getElementById('upload-results').classList.remove('hidden');
        
        if (success) {
            document.getElementById('upload-results').innerHTML = `
                <div class="alert alert-success">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <h3 class="font-bold">Upload Successful!</h3>
                        <p>${result.message || 'Your music has been added to the library.'}</p>
                    </div>
                </div>
                <div class="mt-6 flex gap-4">
                    <button class="btn btn-primary"
                            hx-get="/templates/track-list.html" 
                            hx-target="#main-content" 
                            hx-push-url="/"
                            onclick="updateActiveNav('/')">
                        Go to Music Library
                    </button>
                    <button class="btn btn-ghost" onclick="resetUploadForm()">
                        Upload More
                    </button>
                </div>
            `;
        } else {
            document.getElementById('upload-results').innerHTML = `
                <div class="alert alert-error">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div>
                        <h3 class="font-bold">Upload Failed</h3>
                        <p>${result.error || 'There was an error uploading your music.'}</p>
                        ${result.details ? `<p class="text-sm mt-1">${result.details}</p>` : ''}
                    </div>
                </div>
                <div class="mt-6">
                    <button class="btn btn-primary" onclick="resetUploadForm()">
                        Try Again
                    </button>
                </div>
            `;
        }
    }
    
    function resetUploadForm() {
        document.getElementById('upload-results').classList.add('hidden');
        document.getElementById('album-upload').classList.remove('hidden');
        document.getElementById('tracks-upload').classList.add('hidden');
        document.getElementById('album-upload-form').reset();
        document.getElementById('tracks-upload-form').reset();
        document.getElementById('track-list-preview').classList.add('hidden');
        selectedTracks = [];
        uploadedTracks = [];
        
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('tab-active');
        });
        document.querySelector('.tab').classList.add('tab-active');
    }
</script>