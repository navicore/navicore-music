<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Music - Navicore Music</title>
    <!-- Updated: Large file handling v2 -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@4.4.2/dist/full.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-base-100">
    <div class="container mx-auto p-8 max-w-6xl">
        <div class="flex items-center justify-between mb-8">
            <h1 class="text-3xl font-bold">Upload Music</h1>
            <a href="/" class="btn btn-ghost">Back to Library</a>
        </div>
        
        <!-- Album Upload Form -->
        <div class="card bg-base-200 mb-8">
            <div class="card-body">
                <h2 class="card-title mb-4">Create Album</h2>
                
                <form id="album-upload-form" class="space-y-6">
                    <!-- Album Metadata -->
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="label">
                                <span class="label-text">Album Title*</span>
                            </label>
                            <input type="text" name="album" placeholder="Album Name" 
                                   class="input input-bordered w-full" required />
                        </div>
                        
                        <div>
                            <label class="label">
                                <span class="label-text">Artist Name*</span>
                            </label>
                            <input type="text" name="artist" placeholder="Artist Name" 
                                   class="input input-bordered w-full" required />
                        </div>
                        
                        <div>
                            <label class="label">
                                <span class="label-text">Genre</span>
                            </label>
                            <input type="text" name="genre" placeholder="Genre" 
                                   class="input input-bordered w-full" />
                        </div>
                        
                        <div>
                            <label class="label">
                                <span class="label-text">Year</span>
                            </label>
                            <input type="number" name="year" id="year-input" placeholder="2024" 
                                   class="input input-bordered w-full" min="1900" max="2099" />
                        </div>
                    </div>
                    
                    <!-- File Selection -->
                    <div>
                        <label class="label">
                            <span class="label-text">Select Tracks*</span>
                            <span class="label-text-alt">MP3, FLAC, OGG, M4A, WAV</span>
                        </label>
                        <input type="file" 
                               id="track-files"
                               name="tracks" 
                               accept=".mp3,.flac,.ogg,.m4a,.wav,audio/*" 
                               class="file-input file-input-bordered w-full" 
                               multiple
                               required />
                        <label class="label">
                            <span class="label-text-alt">Hold Ctrl/Cmd to select multiple files</span>
                        </label>
                    </div>
                    
                    <!-- Cover Art -->
                    <div>
                        <label class="label">
                            <span class="label-text">Album Cover (Optional)</span>
                            <span class="label-text-alt">JPG, PNG</span>
                        </label>
                        <input type="file" 
                               name="cover" 
                               accept=".jpg,.jpeg,.png,image/*" 
                               class="file-input file-input-bordered w-full" />
                    </div>
                    
                    <!-- Track List Preview -->
                    <div id="track-list-preview" class="hidden">
                        <h3 class="text-lg font-semibold mb-2">Track Order</h3>
                        
                        <!-- Large file warning banner -->
                        <div id="large-file-warning" class="alert alert-info mb-4 hidden">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <h3 class="font-bold">Files over 100MB will be skipped</h3>
                                <p>Due to upload limits, large files cannot be uploaded and will be automatically skipped.</p>
                            </div>
                        </div>
                        
                        <div class="bg-base-300 rounded-lg p-4">
                            <div id="track-list" class="space-y-2">
                                <!-- Tracks will be listed here -->
                            </div>
                            <p class="text-sm text-base-content/70 mt-2">
                                Drag to reorder tracks â€¢ Click track name to edit
                            </p>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-lg w-full">
                        Upload Album
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Upload Progress -->
        <div id="upload-progress" class="hidden">
            <div class="card bg-base-200">
                <div class="card-body">
                    <h3 class="card-title mb-4">Uploading Album...</h3>
                    
                    <!-- Overall Progress -->
                    <div class="mb-4">
                        <div class="flex justify-between text-sm mb-1">
                            <span>Overall Progress</span>
                            <span id="overall-progress-text">0%</span>
                        </div>
                        <progress id="overall-progress" class="progress progress-primary w-full" value="0" max="100"></progress>
                    </div>
                    
                    <!-- Individual Track Progress -->
                    <div id="track-progress-list" class="space-y-3">
                        <!-- Individual progress bars will appear here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Results -->
        <div id="upload-results" class="hidden">
            <!-- Success or error messages will appear here -->
        </div>
    </div>
    
    <script>
        let selectedTracks = [];
        let uploadedTracks = [];
        
        // Set default year
        document.getElementById('year-input').value = new Date().getFullYear();
        
        // Handle file selection
        document.getElementById('track-files').addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            const maxSize = 100 * 1024 * 1024; // 100MB limit (safe threshold before Cloudflare's 128MB limit)
            
            selectedTracks = files.map((file, index) => ({
                file: file,
                name: extractTrackName(file.name),
                trackNumber: index + 1,
                status: 'pending',
                isLarge: file.size > maxSize
            }));
            
            updateTrackListPreview();
        });
        
        function extractTrackName(filename) {
            // Remove extension
            let name = filename.replace(/\.[^/.]+$/, '');
            // Remove common track number patterns
            name = name.replace(/^\d+[\s\-_.]*/, '');
            // Clean up separators
            name = name.replace(/[\-_]/g, ' ').trim();
            return name || filename;
        }
        
        function updateTrackListPreview() {
            if (selectedTracks.length === 0) {
                document.getElementById('track-list-preview').classList.add('hidden');
                return;
            }
            
            document.getElementById('track-list-preview').classList.remove('hidden');
            const listDiv = document.getElementById('track-list');
            
            // Check if there are any large files
            const hasLargeFiles = selectedTracks.some(t => t.isLarge);
            if (hasLargeFiles) {
                document.getElementById('large-file-warning').classList.remove('hidden');
            } else {
                document.getElementById('large-file-warning').classList.add('hidden');
            }
            
            listDiv.innerHTML = selectedTracks.map((track, index) => `
                <div class="flex items-center gap-3 p-2 bg-base-200 rounded ${track.isLarge ? 'opacity-50' : ''}" data-index="${index}">
                    <span class="text-lg font-semibold w-8 ${track.isLarge ? 'line-through' : ''}">${track.trackNumber}</span>
                    <input type="text" value="${track.name}" 
                           class="input input-sm input-bordered flex-1 track-name-input ${track.isLarge ? 'input-disabled' : ''}"
                           data-index="${index}" 
                           ${track.isLarge ? 'disabled' : ''} />
                    <span class="text-sm opacity-70">${formatFileSize(track.file.size)}</span>
                    ${track.isLarge ? '<span class="badge badge-error badge-sm">Too Large - Will Skip</span>' : ''}
                </div>
            `).join('');
            
            // Add event listeners for track name editing
            document.querySelectorAll('.track-name-input').forEach(input => {
                input.addEventListener('change', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    selectedTracks[index].name = e.target.value;
                });
            });
        }
        
        function formatFileSize(bytes) {
            if (bytes < 1024 * 1024) {
                return (bytes / 1024).toFixed(1) + ' KB';
            }
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }
        
        // Handle form submission
        document.getElementById('album-upload-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const form = e.target;
            const albumData = {
                album: form.elements.album.value,
                artist: form.elements.artist.value,
                genre: form.elements.genre.value || null,
                year: form.elements.year.value ? parseInt(form.elements.year.value) : new Date().getFullYear(),
            };
            
            // Hide form, show progress
            document.getElementById('album-upload-form').parentElement.parentElement.classList.add('hidden');
            document.getElementById('upload-progress').classList.remove('hidden');
            
            // Upload tracks (large files will be skipped)
            await uploadAlbumTracks(albumData, selectedTracks);
        });
        
        async function uploadAlbumTracks(albumData, tracks) {
            const totalTracks = tracks.length;
            let completedTracks = 0;
            
            // Initialize progress display
            const progressList = document.getElementById('track-progress-list');
            progressList.innerHTML = tracks.map((track, index) => `
                <div class="space-y-1" id="track-progress-${index}">
                    <div class="flex justify-between text-sm">
                        <span>${track.trackNumber}. ${track.name}</span>
                        <span class="track-status">Waiting...</span>
                    </div>
                    <progress class="progress progress-secondary w-full h-2" value="0" max="100"></progress>
                </div>
            `).join('');
            
            // Upload tracks sequentially (could be parallel with limits)
            for (let i = 0; i < tracks.length; i++) {
                const track = tracks[i];
                const trackDiv = document.getElementById(`track-progress-${i}`);
                const statusSpan = trackDiv.querySelector('.track-status');
                const progressBar = trackDiv.querySelector('progress');
                
                // Skip large files
                if (track.isLarge) {
                    track.status = 'skipped';
                    statusSpan.textContent = 'Skipped - Too Large';
                    statusSpan.classList.add('text-warning');
                    progressBar.value = 0;
                    progressBar.classList.add('progress-warning');
                    completedTracks++;
                    
                    // Update overall progress
                    const overallPercent = Math.round((completedTracks / totalTracks) * 100);
                    document.getElementById('overall-progress').value = overallPercent;
                    document.getElementById('overall-progress-text').textContent = `${overallPercent}%`;
                    continue;
                }
                
                try {
                    statusSpan.textContent = 'Uploading...';
                    progressBar.value = 50;
                    
                    // Create form data for this track
                    const formData = new FormData();
                    formData.append('file', track.file);
                    formData.append('metadata', JSON.stringify({
                        title: track.name,
                        artist: albumData.artist,
                        album: albumData.album,
                        genre: albumData.genre,
                        year: albumData.year,
                        track_number: track.trackNumber
                    }));
                    
                    const response = await fetch('https://api.navicore.tech/api/v1/upload/file', {
                        method: 'POST',
                        body: formData,
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        track.status = 'completed';
                        track.uploadedData = result.track;
                        uploadedTracks.push(result.track);
                        
                        statusSpan.textContent = 'âœ“ Complete';
                        statusSpan.classList.add('text-success');
                        progressBar.value = 100;
                        progressBar.classList.add('progress-success');
                    } else {
                        const error = await response.json();
                        throw new Error(error.details || error.error);
                    }
                } catch (error) {
                    track.status = 'failed';
                    track.error = error.message;
                    statusSpan.textContent = 'âœ— Failed';
                    statusSpan.classList.add('text-error');
                    progressBar.classList.add('progress-error');
                    
                    // Log detailed error
                    console.error(`Upload failed for ${track.file.name}:`, error);
                }
                
                // Update overall progress
                completedTracks++;
                const overallPercent = Math.round((completedTracks / totalTracks) * 100);
                document.getElementById('overall-progress').value = overallPercent;
                document.getElementById('overall-progress-text').textContent = `${overallPercent}%`;
            }
            
            // Show results
            showUploadResults();
        }
        
        function showUploadResults() {
            document.getElementById('upload-progress').classList.add('hidden');
            document.getElementById('upload-results').classList.remove('hidden');
            
            const successCount = selectedTracks.filter(t => t.status === 'completed').length;
            const failedCount = selectedTracks.filter(t => t.status === 'failed').length;
            const skippedCount = selectedTracks.filter(t => t.status === 'skipped').length;
            
            let resultHtml = '';
            
            if (successCount === selectedTracks.length) {
                resultHtml = `
                    <div class="alert alert-success">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <h3 class="font-bold">Album uploaded successfully!</h3>
                            <p>All ${successCount} tracks have been uploaded.</p>
                        </div>
                    </div>
                `;
            } else if (successCount > 0) {
                resultHtml = `
                    <div class="alert alert-success">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <h3 class="font-bold">Upload complete!</h3>
                            <p>${successCount} tracks uploaded successfully${skippedCount > 0 ? `, ${skippedCount} skipped` : ''}${failedCount > 0 ? `, ${failedCount} failed` : ''}.</p>
                        </div>
                    </div>
                `;
            } else {
                resultHtml = `
                    <div class="alert alert-error">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <div>
                            <h3 class="font-bold">Upload failed</h3>
                            <p>No tracks were uploaded successfully.</p>
                        </div>
                    </div>
                `;
            }
            
            // Show skipped tracks
            const skippedTracks = selectedTracks.filter(t => t.status === 'skipped');
            if (skippedTracks.length > 0) {
                resultHtml += `
                    <div class="mt-4">
                        <h4 class="font-semibold mb-2">Skipped tracks (too large):</h4>
                        <div class="space-y-2">
                            ${skippedTracks.map(track => `
                                <div class="alert alert-info">
                                    <div>
                                        <p class="font-semibold">${track.trackNumber}. ${track.name}</p>
                                        <p class="text-sm">File: ${track.file.name} (${formatFileSize(track.file.size)})</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Show failed tracks
            const failedTracks = selectedTracks.filter(t => t.status === 'failed');
            if (failedTracks.length > 0) {
                resultHtml += `
                    <div class="mt-4">
                        <h4 class="font-semibold mb-2">Failed tracks:</h4>
                        <div class="space-y-2">
                            ${failedTracks.map(track => `
                                <div class="alert alert-error">
                                    <div>
                                        <p class="font-semibold">${track.trackNumber}. ${track.name}</p>
                                        <p class="text-sm">File: ${track.file.name}</p>
                                        <p class="text-sm opacity-70">Error: ${track.error || 'Unknown error'}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            resultHtml += `
                <div class="mt-4 space-y-2">
                    <a href="/" class="btn btn-primary">View Library</a>
                    <button onclick="location.reload()" class="btn btn-ghost">Upload More</button>
                </div>
            `;
            
            document.getElementById('upload-results').innerHTML = resultHtml;
        }
    </script>
</body>
</html>